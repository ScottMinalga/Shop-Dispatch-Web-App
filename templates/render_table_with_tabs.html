{% extends "base.html" %}

{% macro render_table(data, parts_job_numbers) %}
    <!-- Wrap the table and its title in a container -->
    <div class="custom-table-container">
        <h1 class="text-center">{{ data[0].type if data else "No Data" }}</h1>
        <div class="table-responsive">
            <table class="table table-striped">
    <thead>
      <tr>
        <th>Parts Status</th>
        <th>Project Number</th>
        <th>Job Number</th>
        <th>Sales Order</th>
        <th>Customer Name</th>
        <th>Builder</th>
        <th>Status</th>
        <th>Notes</th>
        <th>Due Date</th>
        <th>Order Date</th>
        <th>Ship Date</th>
        <th>Quantity</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for job in data %}
      <tr>
        {% if job.job_number in parts_job_numbers %}
          <td><a href="{{ url_for('view_parts', job_number=job.job_number|string()) }}"><svg width="20" height="20"><polygon points="10,0 20,20 0,20" fill="red" /></svg></a></td>
        {% else %}
          <td><svg width="20" height="20"><polygon points="10,0 20,20 0,20" fill="green" /></svg></td>
        {% endif %}
          <td>{{ job.project_number }}</td>
          <td>{{ job.job_number }}</td>
          <td>{{ job.sales_order }}</td>
          <td>{{ job.customer_name }}</td>
          <td>{{ job.builder }}</td>
          <td>{{ job.status }}</td>
          <td>{{ job.notes }}</td>
          <td>{{ job.due_date }}</td>
          <td>{{ job.order_date }}</td>
          <td>{{ job.ship_date }}</td>
          <td>{{ job.order_quantity }}</td>
          <td>
            <div class="btn-group">
              <a href="{{ url_for('move_job', job_id=job.id) }}" class="btn btn-primary btn-sm">Move</a>
              <form class="edit-form" method="POST" action="{{ url_for('edit_entry', table_name=job.__tablename__, entry_id=job.id) }}">
                {% if entry is defined %}
                  {% if entry.id == job.id %}
                    <button type="button" class="btn btn-warning btn-sm edit-btn" data-toggle="modal" data-target="#editModal{{ entry.id }}">Edit</button>
                  {% else %}
                    <button type="button" class="btn btn-warning btn-sm edit-btn" data-toggle="modal" data-target="#editModal{{ job.id }}">Edit</button>
                  {% endif %}
                {% else %}
                  <button type="button" class="btn btn-warning btn-sm edit-btn" data-toggle="modal" data-target="#editModal{{ job.id }}">Edit</button>
                {% endif %}
              </form>
              <a href="{{ url_for('delete_entry', table_name=job.__tablename__, entry_id=job.id) }}" class="btn btn-danger btn-sm">Delete</a>
            </div>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
  {% endmacro %}

  {% block content %}
  <style>
    .custom-table-container {
        padding-left: -5;
        padding-right: 0;
    }
  </style>
    
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Entry</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="editForm" method="POST">
              <div class="form-group">
                <label for="projectnum">Project Number</label>
                <input type="text" class="form-control" id="projectnum" name="projectnum" required>
              </div>
              <div class="form-group">
                <label for="jobnum">Job Number</label>
                <input type="text" class="form-control" id="jobnum" name="jobnum" required>
              </div>
              <div class="form-group">
                <label for="salesnum">Sales Order</label>
                <input type="text" class="form-control" id="salesnum" name="salesnum" required>
              </div>
              <!-- Add more form fields for editing other data as needed -->
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="submit" form="editForm" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>
  
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-2">
          <div class="list-group">
            {% for status in statuses %}
              <a href="{{ url_for('jobs_by_status', status_name=status) }}" class="list-group-item">{{ status }}</a>
            {% endfor %}
          </div>
        </div>
        <div class="col-md-10">
          <!-- Tab navigation -->
          <ul class="nav nav-tabs" id="myTabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="ASM01-tab" data-toggle="tab" href="#ASM01" role="tab" aria-controls="ASM01" aria-selected="true">ASM01</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="ASM02-tab" data-toggle="tab" href="#ASM02" role="tab" aria-controls="ASM02" aria-selected="false">ASM02</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="archive-tab" data-toggle="tab" href="#archive" role="tab" aria-controls="archive" aria-selected="false">Archive</a>
            </li>
          </ul>

          <!-- Tab content -->
          <div class="tab-content">
            <div class="tab-pane fade show active" id="ASM01" role="tabpanel" aria-labelledby="ASM01-tab">
              <h3>ASM01 Data</h3>
              {{ render_table(ASM01_data, parts_job_numbers) }}
            </div>
            <div class="tab-pane fade" id="ASM02" role="tabpanel" aria-labelledby="ASM02-tab">
              <h3>ASM02 Data</h3>
              {{ render_table(ASM02_data, parts_job_numbers) }}
            </div>
            <div class="tab-pane fade" id="archive" role="tabpanel" aria-labelledby="archive-tab">
              <h3>Archive Data</h3>
              {{ render_table(archive_data, parts_job_numbers) }}
            </div>
          </div>
        </div>
      </div>
    </div>

      
    <script>
      function storeActiveTab(tabId) {
        localStorage.setItem('activeTab', tabId);
      }
  
      function restoreActiveTab() {
        const activeTabId = localStorage.getItem('activeTab');
        if (activeTabId) {
          // Deactivate all tabs
          document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            link.setAttribute('aria-selected', 'false');
          });
  
          // Deactivate all tab content panes
          document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('show', 'active');
          });
  
          // Activate the stored tab and its content pane
          const activeTab = document.getElementById(`${activeTabId}-tab`);
          const activePane = document.getElementById(activeTabId);
          if (activeTab && activePane) {
            activeTab.classList.add('active');
            activeTab.setAttribute('aria-selected', 'true');
            activePane.classList.add('show', 'active');
          }
        }
      }
  
      document.addEventListener('DOMContentLoaded', function() {
          restoreActiveTab();
  
          document.querySelectorAll('.nav-link').forEach(link => {
              link.addEventListener('click', function() {
                  storeActiveTab(this.getAttribute('aria-controls'));
              });
          });
      });
  
      // Refresh the page every 3 minutes (180000 milliseconds)
      setTimeout(function() {
        location.reload();
      }, 180000);
  
      $(document).on('submit', '.edit-form', function(e) {
        // When an edit form is submitted...
        e.preventDefault(); // Prevent the default form submission behavior
        var form = $(this); // Get the form that was submitted
        var url = form.attr('action'); // Get the URL to submit the form to
        var data = form.serialize(); // Serialize the form data into a string
        $.ajax({
          type: 'POST', // Use HTTP POST method
          url: url, // Set the URL to submit the data to
          data: data, // Set the serialized form data as the request body
          success: function(response) {
            // When the AJAX request is successful...
            var row = $('#entry_' + response['id']); // Get the table row for the updated entry
            row.find('.projectnum').text(response['project_number']); // Update the project number column with the new value
            row.find('.jobnum').text(response['job_number']); // Update the job number column with the new value
            row.find('.salesnum').text(response['sales_order']); // Update the sales order column with the new value
            // Add more lines to update other columns as needed
            $('#editModal').modal('hide'); // Hide the edit modal
          },
          error: function(xhr, status, error) {
            // When the AJAX request encounters an error...
            console.error(xhr.responseText); // Log the error message to the console
          }
        });
      });
  
  </script>

{% endblock %}